<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0050)http://myownplayground.atspace.com/cookietest.html -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Browser Cookie Limits</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
    <!--<script src="https://github.com/carhartl/jquery-cookie/raw/master/jquery.cookie.js"></script>--> 
    <!--<script src="./../../Scripts/jquery-1.4.1.js" type="text/javascript"></script>  
    <script src="./../../Scripts/jquery.cookie.js" type="text/javascript"></script>--> 
</head><body>
<script type="text/javascript">
    $(function() {

        $('#butRefresh').click(function() {
            deleteAllCookies();
            document.location.reload();
        });

        $('#makeAccurate').live('click', function() {
            getAccurateMaxSizePerDomain();
            return false;
        });

        $('#executeCount').click(function() {
            var number = Number($('#repeat').val());
            var c = $('#character').val();
            testMaxCookies(number, c);
        });

        $('#executeTests').click(function() {
            testCookieMaxSize();
            return false;
        });
        
        var autoRunTest = gup('autorun');
        if (autoRunTest == "true")
            testCookieMaxSize();
        else
            $('#executeTests').show();
    });
function assertNoCookies()
{
    var count = getcookieCount();
    if (count == 0)
        return;
    error('ERROR: Starting with some cookies');
    info(''+document.cookie);
}
function testCookieMaxSize() {
    $('#executeTests').hide();
    info('Starting');  
    var singleByteCharacter = '1';
    var multiByteCharacter = "ÿ";
    var encodedEscapeCharacter = '%';
    
    cookieCountSmallSize = testMaxCookies(3,singleByteCharacter);
    
    maxSizeSingle = testMaxCookieSize(singleByteCharacter);
    cookieCountMaxSizeSingle = testMaxCookies(maxSizeSingle, singleByteCharacter);
    
    maxSizeMulti = testMaxCookieSize(multiByteCharacter);
    cookieCountMaxSizeMulti = testMaxCookies(maxSizeMulti, multiByteCharacter);
    
    sizeIsLimitedToUnits = 'bytes';
    var utf8Supported = true; // Assumption for now
    if (utf8Supported && maxSizeSingle == maxSizeMulti)
        sizeIsLimitedToUnits = 'characters'
    
    var maxSizePerDomain = 'Between '+(cookieCountMaxSizeSingle * maxSizeSingle) + ' and ' + ((cookieCountMaxSizeSingle * maxSizeSingle) + maxSizeSingle - 1) + ' ' + sizeIsLimitedToUnits;
    if (cookieCountMaxSizeSingle == cookieCountSmallSize)
    {
        maxSizePerDomain = 'NA';
    } else{
        maxSizePerDomain += "<a id='makeAccurate' href='#'>Make Accurate (SLOW)</a>";        
    }
    
    // TO SLOW!!
    //var overallMaxSize = testMaxCookiesSizePerDomain(maxSizeSingle,cookieCountSmallSize);
    
    info('<b>Guessing Max Cookie Count Per Domain: ' + cookieCountSmallSize+'</b>');
    info('<b>Guessing Max Cookie Size Per Cookie: ' + maxSizeSingle + ' ' + sizeIsLimitedToUnits+'</b>');
    info('<b>Guessing Max Cookie Size Per Domain: ' + maxSizePerDomain+'</b>');
    //maxSize = testMaxCookieSize(encodedEscapeCharacter);
    //testMaxCookies(maxSize, encodedEscapeCharacter);
}
function getAccurateMaxSizePerDomain()
{
    info('Starting to get Accurate Max Size Per Domain, may take awhile');  
    window.setTimeout(function(){    
        var overallMaxSize = testMaxCookiesSizePerDomain(maxSizeSingle,cookieCountSmallSize);            
        info('<b>Guessing Max Cookie Size Per Domain: ' + overallMaxSize+' '+sizeIsLimitedToUnits+'</b>');
    },0);
}
function testMaxCookiesSizePerDomain(maxCookieLength, maxCookieCount)
{
    deleteAllCookies();
    var currentIndex = 1;
    var currentValue = '1';
    var overallSize = 3;
    while (true)
    {     
        var hitCookieSizeLimit = (currentIndex+'='+currentValue).length == maxCookieLength;
        if (hitCookieSizeLimit)
        {
            // Time to fill up the next cookie
            currentIndex++;
            currentValue = '1';
            setCookie(currentIndex, currentValue);
            //document.cookie=currentIndex+'='+currentValue;
            var storedCookieCount = getcookieCount();
            var notAllCookiesAreStored = storedCookieCount != currentIndex;
            if (notAllCookiesAreStored)
            {
                info('Max Cookies Size Per Domain: ' + overallSize);
                break;
            }
            overallSize+=3;   
        } else
        {
            // Add to the current cookies value
            currentValue += '1';
            document.cookie=currentIndex+'='+currentValue;
            var storedCookieValue = readCookie(currentIndex);
            var cookieSame = storedCookieValue == currentValue;
            if (!cookieSame)
            {
                info(currentIndex + ' : '+ currentValue + ' : ' + storedCookieValue);
                info('Max Cookies Size Per Domain: ' + overallSize);
                break;
            }
            overallSize++;
        }
        
        if (currentIndex > maxCookieCount)
        {
            info('Max Cookies Size Per Domain: NA');
            break;
        }        
    }    
    deleteAllCookies();
    return overallSize;
}
function testMaxCookies(cookieSize, cookieValueCharacter)
{
    deleteAllCookies();
    var currentIndex = 1;
    while (true)
    {
        var cookieValue = cookieValueCharacter;
        var cookie = currentIndex+'='+cookieValue;
        var expandValueBy = cookieSize - cookie.length;
        for (var i = 0; i < expandValueBy; i++)
        {
            cookieValue+=cookieValueCharacter;
        }
        setCookie(currentIndex, cookieValue);
        //document.cookie=currentIndex+'='+cookieValue;
        //$.cookie(currentIndex,cookieValue);
        var currentCount = getcookieCount();
        if (currentIndex != currentCount)
        {
            info('Max Cookies with Character Length ' + cookieSize + ' and character "' + cookieValueCharacter + '": ' + (currentIndex - 1));
            deleteCookie(currentIndex - 1);
            break;
        }
        if (currentIndex > 1000)
        {
            info('Gave up At Cookies Character Length '+cookieSize + ' and character "' + cookieValueCharacter +'": ' + (currentIndex-1));        
            break;
        }
        currentIndex++;
    }    
    deleteAllCookies();
    return currentIndex-1;
}
function testMaxCookieSize(cookieValueCharacter)
{
    deleteAllCookies();
    var incrementWith = cookieValueCharacter;//'1111111111111111'
    var incrementSize = 1;//16;
    var value = incrementWith;//'11111111111111';
    var key = '1';
    var size = 3;//14+1+1; // Size includes key and '=' and value. Initially it is 1=1
    var weAreTestingMaxOf = 'Key';
    while (true) {
        setCookie(key, value);
        //document.cookie=key+'='+value;
        //$.cookie(key,value);
        var readValue = readCookie(key);
        var cookieSavedCorrectly = readValue == value;
        if (!cookieSavedCorrectly)
        {
            var lastKnownGoodSize = size-incrementSize;
            info('Max Cookie Character Length using character "' + cookieValueCharacter + '": ' + lastKnownGoodSize);
            deleteCookie(key);
            deleteAllCookies();
            return lastKnownGoodSize;
        }
        size+=incrementSize;
        value+=incrementWith;
        if (size > 20000)
        {
            info('Gave Up At Cookie Character Length using character "' + cookieValueCharacter +'": ' + size);
            deleteAllCookies();
            deleteCookie(key);
            throw "Cound not determine max cookie size";
        }
    }
}
cookieNames = {};
function setCookie(name, value) {
    cookieNames[name] = 1;
    document.cookie = name + '=' + value;
}
function readCookie(name) {
	var nameEQ = name + "=";
	var ca = document.cookie.split(';');
	for(var i=0;i < ca.length;i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1,c.length);
		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
	}
	return null;
}
function deleteAllCookies() {
    var cookies = document.cookie.split(";");
    
    for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i];
        var eqPos = cookie.indexOf("=");
        var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
        deleteCookie(name);
    }
    for (var name in cookieNames)
    {
        deleteCookie(name);
    }
    // To be sure to be sure 
    for (var name in cookieNames) {
        deleteCookie(name);
    }
    cookieNames = {};
    // Still getting some, so trying this
    for (var i = 1; i < 1000; i++) {
        deleteCookie(i);
    }
    assertNoCookies();
}

function deleteCookie(name)
{
    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
    delete cookieNames[name];
}
function getcookieCount()
{
    if (!document.cookie)
        return 0;
    return document.cookie.split(";").length;
};
function get_cookies_array() {

    var cookies = { };

    if (document.cookie && document.cookie != '') {
        var split = document.cookie.split(';');
        for (var i = 0; i < split.length; i++) {
            var name_value = split[i].split("=");
            name_value[0] = name_value[0].replace(/^ /, '');
            cookies[decodeURIComponent(name_value[0])] = decodeURIComponent(name_value[1]);
        }
    }
    return cookies;
}

function info(message) {
    var when = new Date();
    var whenStr = when.getHours() + ':' + when.getMinutes() + ':' + when.getSeconds() + '.' + when.getMilliseconds();
    $('#log').append('<div>' + whenStr + ': ' + message + '</div>');
}
function error(message) {
    info('<font color="red">' + message + '</font>');
}
function gup(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regexS = "[\\?&]" + name + "=([^&#]*)";
    var regex = new RegExp(regexS);
    var results = regex.exec(window.location.href);
    if (results == null)
        return "";
    else
        return results[1];
}
</script>

<style>
button {
  width:200px;
  height: 50px;
}
</style>

<h1>Cookie Limits Test</h1>
<p>stolen from <a href="http://myownplayground.atspace.com/cookietest.html">http://myownplayground.atspace.com/cookietest.html</a></p>

<p>I have a requirement to store a large amount of data in cookies, to figure out if it will work 
here are my tests. 
</p>
<p>
If all you care about is the conclusion, well here it is: If you want to support <b>most</b> browsers, then don't exceed <b>50 cookies per domain</b>, and don't exceed <b>4095 bytes per domain</b> (i.e. total size of all cookies <= 4095 bytes)
</p>
<h2>Current Browser Test Results</h2>
<div id="log">

</div>
<button id="executeTests">Run Tests For Current Browser</button>
<h2>About The Tests</h2>
<p>
<b>Max Cookie Count Per Domain</b> is calculated by adding cookies until the number of cookies saved stops increasing.
</p>
<p>
<b>Max Cookie Size Per Cookie</b> is calculated by increasing the cookies value one character at a time, until the saved value is truncated.
</p>
<p>
<b>Max Cookie Size Per Domain</b> is guessed by adding cookies of maximum size, until no more cookies can be added.
Hence, the actual limit may be more than the guessed limit. Guessed Limit &lt;= Actual Limit &lt; Guessed Limit + Max CookieSize
</p>
<h2>Manually Execute Tests</h2>
<div>
<h3>1. Max Cookies Test</h3>
Each cookie will be filled with the following character, repeated the specified number of times.<br />
Character: <input id="character" /> Repeat Character Times: <input id="repeat" /> <button id="executeCount">Execute</button>
</div>


<h2>Some Interesting Things</h2>
Typically, the following are allowed:
<ul>
    <li>300 cookies in total</li>
    <li>4096 bytes per cookie </li>
    <li>20 cookies per domain</li>
    <li>81920 bytes per domain<sup>*</sup></li>
</ul>
* Given 20 cookies of max size 4096 = 81920 bytes.
<br><br>
IE (and Opera) introduces a new limit, <b>max bytes per domain</b>
<br><br>
A few notes about cookies:
<ul>
    <li><a href="http://www.ietf.org/rfc/rfc2965.txt">RFC 2965</a></li>
    <li><a href="http://www.thismuchiknow.co.uk/?p=13">Someone’s experience with IE6 limits</a></li>
    <li>To get a good understanding of cookies read <a href="http://www.quirksmode.org/js/cookies.html">this</a></li>
    <li>Cookies are stored as a single string containing name, value, expiry etc.</li>
    <li>Size limits apply to the entire cookie, not just its value.</li>
    <li>If you use characters only in the ASCII range, each character takes 1 byte, so you can typically store 4096 characters</li>
    <li>In UTF-8 some characters are more than 1 byte, hence you can not store as many characters in the same amount of bytes.</li>
    <li>The ';' character is reserved as a separator. Do not use it in the key or value.</li>
    <li>jQuery Cookie plugin stores the cookie using encodeURIComponent. Hence ÿ is stored as %C3%BF, 6 characters. This works well, as other you would lose the ';' character</li>
    <li>You cannot delete cookies with a key that hits the size limit and has a small value. The method to delete a cookie is to set its expiry value, but when the key is large there is not enough room left to do this. Hence I have not tested limitations around key size.</li>
    <li>It appears that some browsers limit by bytes, while others limit the number of characters.</li>
</ul>

<h2>Alternatives</h2>
<ul>
    <li><a href="http://www.jstorage.info/">jStorage</a> is quite a good alternative that I am considering using. It stores the data on the client only (ie not sent to server) and is supported by the major browsers.</li>
    <li>Just store an id in the cookie, and then store the data in a database</li>
</ul>


<h2>Browser Limits</h2>
After testing a few browsers myself, and using <a href="http://browsershots.org">Browser Shots</a> I have compiled the following list:
<table border=1>
    <thead>
        <tr>
            <th>Browser</th>
            <th>Max Cookies</th>
            <th>Max Size Per Cookie</th>
            <th>Max Size Per Domain<sup>1</sup></th>
            <th>Usage<sup>2</sup></th>
        </tr>
    </thead>
    <tbody>
<TR><TD>Chrome 4</TD><TD></TD><TD></TD><TD></TD><TD></TD></TR>
<TR><TD>Chrome 5</TD><TD>70</TD><TD>4096 bytes</TD><TD>NA</TD><TD></TD></TR>
<TR><TD>Chrome 6</TD><TD>70</TD><TD>4096 bytes</TD><TD>NA</TD><TD></TD></TR>
<TR><TD>Chrome 7</TD><TD>70</TD><TD>4096 bytes</TD><TD>NA</TD><TD></TD></TR>
<TR><TD>Chrome 8</TD><TD>180</TD><TD>4096 bytes</TD><TD>NA</TD><TD>0.6%</TD></TR>
<TR><TD>Chrome 9</TD><TD></TD><TD></TD><TD></TD><TD>7.7%</TD></TR>
<TR><TD>Chrome 10</TD><TD>180</TD><TD>4096 bytes</TD><TD>NA</TD><TD>14.8%</TD></TR>
<TR><TD>Chrome 11</TD><TD></TD><TD></TD><TD></TD><TD>0.8%</TD></TR>
<TR><TD>Chrome 12</TD><TD></TD><TD></TD><TD></TD><TD>0.1%</TD></TR>
<TR><TD>FireFox 2</TD><TD>50</TD><TD>4097 characters</TD><TD>NA</TD><TD></TD></TR>
<TR><TD>FireFox 3</TD><TD>50</TD><TD>4097 characters</TD><TD>NA</TD><TD>36.7%</TD></TR>
<TR><TD>FireFox 4</TD><TD>50</TD><TD>4098 characters</TD><TD>NA</TD><TD>5.2%</TD></TR>
<TR><TD>IE 6</TD><TD>50</TD><TD>4096 characters</TD><TD>4096 characters</TD><TD>3.0%</TD></TR>
<TR><TD>IE 7</TD><TD>50</TD><TD>4095 characters</TD><TD>4095 characters</TD><TD>5.4%</TD></TR>
<TR><TD>IE 8</TD><TD>50</TD><TD>5117 characters</TD><TD>10234 characters</TD><TD>16.3%</TD></TR>
<TR><TD>IE 9</TD><TD></TD><TD></TD><TD></TD><TD>1.1%</TD></TR>
<TR><TD>Opera 8</TD><TD>30</TD><TD>4096 bytes</TD><TD>4096 bytes</TD><TD></TD></TR>
<TR><TD>Opera 9</TD><TD>30</TD><TD>4096 bytes</TD><TD>4096 bytes</TD><TD></TD></TR>
<TR><TD>Opera 10</TD><TD></TD><TD></TD><TD></TD><TD>0.2%</TD></TR>
<TR><TD>Opera 11</TD><TD>60</TD><TD>4096 bytes</TD><TD>4096 bytes</TD><TD>1.9%</TD></TR>
<TR><TD>Safari 3</TD><TD></TD><TD></TD><TD></TD><TD>0.1%</TD></TR>
<TR><TD>Safari 4</TD><TD></TD><TD></TD><TD></TD><TD>0.3%</TD></TR>
<TR><TD>Safari 5</TD><TD>600</TD><TD>4096 bytes</TD><TD>4096 bytes</TD><TD>3.6%</TD></TR>
<TR><TD>Safari on mac<sup>3</sup></TD><TD>?</TD><TD>?</TD><TD>?</TD><TD></TD></TR>
    </tbody>
</table>
<sup>1</sup> NA means there is no limit other than Max Cookies * Max Size Per Cookie<br />
<sup>2</sup> From March 2011 <a href="http://www.w3schools.com/browsers/browsers_stats.asp">W3 Schools Browser Statistics</a><br />
<sup>3</sup> Lu pointed out Safari on mac is different to windows. It appears to have <a href="http://www.ghacks.net/2008/08/16/browser-cookie-limits/">no limit</a>. I will investigate when I get more time.
<h2>Conclusion</h2>
If you want to support most browsers, then don't exceed 50 cookies per domain, and don't exceed 4095 bytes per domain (i.e. total size of all cookies <= 4095 bytes)
<h2>Updates</h2>
<ul>
    <li>10 March 2011
        <ul>
            <li>Added Chrome 10</li>
            <li>Safari Mac uncertain on limit</li>
            <li>March 2011 W3 stats</li>
            <li>Increased conclusion from 30 cookied to 50 now that opera 8 and 9 are older</li>
        </ul>
    </li>
</ul>
</body></html>
